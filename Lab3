CREATE DATABASE QuanLySinhVien;
GO


USE QuanLySinhVien;
GO

CREATE TABLE Khoa (
MAKH Char(2) PRIMARY KEY,
TENKH nvarchar(50)
);
GO

CREATE TABLE SinhVien (
MASV char(3) PRIMARY KEY,
HOSV nvarchar(15),
TENSV nvarchar(15),
PHAI bit,
NGAYSINH datetime,
NOISINH nvarchar(50),
MAKH char(2),
HOCBONG int,
FOREIGN KEY (MAKH) REFERENCES Khoa(MAKH)
);
GO


CREATE TABLE MonHoc(
MAMH char(3) PRIMARY KEY,
TENMH nvarchar(50),
SOTIET int
);
go

CREATE TABLE KetQua (
MASV char(3),
MAMH char(3),
DIEM real,
PRIMARY KEY (MASV, MAMH),
FOREIGN KEY (MASV) REFERENCES SinhVIen(MASV),
FOREIGN KEY (MAMH) REFERENCES MonHoc(MAMH),
);
GO


INSERT INTO Khoa (MAKH, TENKH) VALUES ('01', 'Khoa CNTT');
INSERT INTO Khoa (MAKH, TENKH) VALUES ('02', 'Khoa Kinh Te');
GO


INSERT INTO SinhVien (MASV, HOSV, TENSV, PHAI, NGAYSINH, NOISINH, MAKH, HOCBONG)
VALUES
('001', 'Nguyen', 'An', 1, '2000-01-01', 'Ha Noi', '01', 1000000),
('002', 'Tran', 'Binh', 0, '1999-05-15', 'Hai Phong', '02', 2000000);
GO


INSERT INTO MonHoc(MAMH, TENMH,SOTIET)
VALUES
('MH1', 'Toan', 30),
('MH2', 'Ly', 25);
GO


INSERT INTO KetQua ( MASV, MAMH, DIEM)
VALUES
('001', 'MH1', 8.5),
('001', 'MH2', 7.0),
('002', 'MH1', 9.0),
('002', 'MH2', 6.5);
GO


SELECT * FROM Khoa;
SELECT * FROM SinhVien;
SELECT * FROM MonHoc;
SELECT * FROM KetQua;
GO

---1
SELECT SV.MASV, SV.HOSV + ' ' + SV.TENSV AS HoTen, SV.NGAYSINH
FROM SinhVien SV
JOIN Khoa K ON SV.MAKH = K.MAKH
WHERE K.TENKH = 'Khoa Vật Lý'
ORDER BY SV.NGAYSINH DESC;

---2
SELECT SV.MASV, SV.HOSV + ' ' + SV.TENSV AS HoTen, SV.MAKH, SV.HOCBONG
FROM SinhVien SV
WHERE SV.HOCBONG > 100000
ORDER BY SV.MAKH DESC;

---3
SELECT SV.HOSV + ' ' + SV.TENSV AS HoTen, SV.MAKH, K.TENKH, SV.HOCBONG
FROM SinhVien SV
JOIN Khoa K ON SV.MAKH = K.MAKH
WHERE CONVERT(date, SV.NGAYSINH) = '1981-12-20';

---4
SELECT SV.HOSV + ' ' + SV.TENSV AS HoTen, SV.NGAYSINH
FROM SinhVien SV
JOIN Khoa K ON SV.MAKH = K.MAKH
WHERE K.MAKH = '01' 
  AND SV.PHAI = 1 
  AND SV.NGAYSINH > '1981-05-30';

---5
SELECT SV.MASV, SV.NGAYSINH, SV.PHAI, SV.MAKH
FROM SinhVien SV
WHERE SV.HOCBONG BETWEEN 80000 AND 200000
ORDER BY SV.HOCBONG DESC;

---6
SELECT MAMH, TENMH, SOTIET
FROM MonHoc
WHERE SOTIET > 40 AND SOTIET < 60;

---7
SELECT MASV, CONCAT(HOSV, ' ', TENSV) AS HOTENSV, PHAI
FROM SinhVien
INNER JOIN Khoa ON SinhVien.MAKH = Khoa.MAKH
WHERE TENKH = 'Khoa Anh văn' AND PHAI = 1;

---8
SELECT CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, SV.NGAYSINH, SV.MAKH, K.TENKH, MH.MAMH, MH.TENMH, KQ.DIEM
FROM SinhVien SV
INNER JOIN Khoa K ON SV.MAKH = K.MAKH
INNER JOIN KetQua KQ ON SV.MASV = KQ.MASV
INNER JOIN MonHoc MH ON KQ.MAMH = MH.MAMH
WHERE K.TENKH = 'Khoa CNTT'
ORDER BY KQ.DIEM DESC, MH.MAMH ASC;

---9
SELECT CONCAT(HOSV, ' ', TENSV) AS HOTENSV, PHAI, DAY(NGAYSINH) AS NGAY
FROM SinhVien
WHERE YEAR(NGAYSINH) = 1980 AND MONTH(NGAYSINH) = 2
ORDER BY NGAY DESC;

---10
SELECT MASV, PHAI, MAKH, CASE 
WHEN HOCBONG > 100000 THEN 'Học bổng cao' 
           ELSE 'Mức trung bình' 
       END AS MUCHOCHBONG
FROM SinhVien;

---11
SELECT CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, KQ.MAMH, KQ.DIEM
FROM SinhVien SV
INNER JOIN KetQua KQ ON SV.MASV = KQ.MASV
ORDER BY HOTENSV ASC, KQ.MAMH ASC;

---12
SELECT K.TENKH, CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, MH.TENMH, MH.SOTIET, KQ.DIEM
FROM SinhVien SV
INNER JOIN Khoa K ON SV.MAKH = K.MAKH
INNER JOIN KetQua KQ ON SV.MASV = KQ.MASV
INNER JOIN MonHoc MH ON KQ.MAMH = MH.MAMH
WHERE K.TENKH = 'Khoa Tin Học';

---13
SELECT CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, K.TENKH, CASE 
WHEN SV.PHAI = 1 THEN 'Nam' 
ELSE 'Nữ' END AS GIOITINH,SUM(KQ.DIEM) AS TONGDIEM
FROM SinhVien SV
INNER JOIN Khoa K ON SV.MAKH = K.MAKH
INNER JOIN KetQua KQ ON SV.MASV = KQ.MASV
GROUP BY SV.HOSV, SV.TENSV, K.TENKH, SV.PHAI
ORDER BY HOTENSV;

---14
SELECT K.TENKH, COUNT(SV.MASV) AS TONGSINHVIEN
FROM Khoa K
LEFT JOIN SinhVien SV ON K.MAKH = SV.MAKH
GROUP BY K.TENKH;

---15
SELECT CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, 
MAX(KQ.DIEM) AS DIEMCAONHAT
FROM SinhVien SV
LEFT JOIN KetQua KQ ON SV.MASV = KQ.MASV
GROUP BY SV.HOSV, SV.TENSV;

---16
SELECT TOP 1 TENMH, SOTIET
FROM MonHoc
ORDER BY SOTIET DESC;

---17
SELECT SV.MASV, SV.HOSV, SV.TENSV, SV.MAKH
FROM SinhVien SV
INNER JOIN (
    SELECT MASV, COUNT(*) AS SoMonRot
    FROM KetQua
    WHERE DIEM < 5
    GROUP BY MASV
    HAVING COUNT(*) > 2
) KQ ON SV.MASV = KQ.MASV;

---18
SELECT K.MAKH, K.TENKH,COUNT(SV.MASV) AS TONGSINHVIEN
FROM Khoa K
LEFT JOIN SinhVien SV ON K.MAKH = SV.MAKH
GROUP BY K.MAKH, K.TENKH
HAVING COUNT(SV.MASV) > 10;

---19
SELECT SV.MASV, SV.MAKH, SV.PHAI
FROM SinhVien SV
LEFT JOIN KetQua KQ ON SV.MASV = KQ.MASV
WHERE KQ.MASV is null;

---20
SELECT SV.MASV, CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, SV.MAKH
FROM SinhVien SV
WHERE SV.MASV NOT IN (SELECT KQ.MASV
FROM KetQua KQ
WHERE KQ.MAMH = 'MH_DH');

---21
WITH TotalHocBongTinHoc AS
(SELECT SUM(HOCBONG) AS TotalHocBong
FROM SinhVien
WHERE MAKH = '01')
SELECT SV.MASV, 
CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, SV.MAKH, SV.HOCBONG
FROM SinhVien SV
WHERE SV.HOCBONG > (SELECT TotalHocBong FROM TotalHocBongTinHoc);

---22
WITH DiemCaoNhatTheoMon AS (
SELECT KQ.MASV, 
CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV, MH.TENMH, KQ.DIEM,
ROW_NUMBER() OVER(PARTITION BY KQ.MAMH ORDER BY KQ.DIEM DESC) AS RowNum
FROM KetQua KQ
INNER JOIN SinhVien SV ON KQ.MASV = SV.MASV
INNER JOIN MonHoc MH ON KQ.MAMH = MH.MAMH)
SELECT MASV, HOTENSV, TENMH, DIEM
FROM DiemCaoNhatTheoMon
WHERE RowNum = 1;

--~1
CREATE VIEW SINHVIEN_KHOA_TH AS
SELECT SV.MASV,CONCAT(SV.HOSV, ' ', SV.TENSV) AS HOTENSV,SV.PHAI, SV.NGAYSINH, SV.NOISINH, SV.MAKH, SV.HOCBONG
FROM SinhVien SV
WHERE SV.MAKH = '01';

--~2
DROP VIEW IF EXISTS SINHVIEN_KHOA_TH;

--~3
CREATE VIEW MonHoc_TenBatDau_T AS
SELECT MAMH, TENMH, SOTIET
FROM MonHoc
WHERE TENMH LIKE 'T%';

--~4
CREATE VIEW SinhVien_HoTenChua_Thi AS
SELECT MASV, CONCAT(HOSV, ' ', TENSV) AS HOTENSV, PHAI, NGAYSINH, NOISINH, MAKH, HOCBONG
FROM SinhVien
WHERE HOSV LIKE '%Thị%' OR TENSV LIKE '%Thị%';

--~5
CREATE VIEW SinhVien_SinhVao_20121981 AS
SELECT MASV, CONCAT(HOSV, ' ', TENSV) AS HOTENSV, PHAI, NGAYSINH, NOISINH, MAKH, HOCBONG
FROM SinhVien
WHERE CONVERT(date, NGAYSINH, 103) = '1981-12-20';



